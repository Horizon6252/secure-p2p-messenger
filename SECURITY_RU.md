# Документация по безопасности

Комплексный анализ безопасности Secure P2P Messenger.

[English](SECURITY.md) | [Русский](#русский)

---

## Русский

## Содержание

1. [Криптографическая архитектура](#криптографическая-архитектура)
2. [Модель угроз](#модель-угроз)
3. [Функции безопасности](#функции-безопасности)
4. [Устойчивость к атакам](#устойчивость-к-атакам)
5. [Известные ограничения](#известные-ограничения)
6. [Лучшие практики](#лучшие-практики)
7. [Раскрытие уязвимостей](#раскрытие-уязвимостей)

---

## Криптографическая архитектура

### Сквозное шифрование (E2EE)

Мессенджер реализует многослойную схему шифрования:

```
Пользователь A                  Сервер                  Пользователь B
      │                           │                           │
      │ ─── Код доступа ─────────► │ ◄─── Код доступа ───────  │
      │                           │                           │
      │ ◄── Ed25519 Идентификатор ─┤─── Ed25519 Идентификатор ► │
      │                           │                           │
      │ ─────── X25519 ECDH обмен ключами (через сервер) ───► │
      │                           │                           │
      │ ◄──────── Общий секрет (AES-256-GCM) ──────────────► │
      │                           │                           │
      │ ─── Зашифрованное сообщение ► │ ─── Зашифрованное ───► │
      │     (Сервер не может расшифровать) │  (Сервер не может) │
```

### Криптографические компоненты

#### 1. Генерация идентификатора (Ed25519)

**Цель:** Детерминированный публичный ID из кода доступа

```dart
// Псевдокод
код_доступа → SHA-256 → seed (32 байта)
seed → Ed25519 KeyPair
publicKey → base64 → Публичный ID (виден другим)
privateKey → base64 → Приватный ключ (хранится локально)
```

**Свойства:**
- Детерминированность: Один код всегда генерирует одни ключи
- Мультиустройство: Используйте один код на всех устройствах
- Нет хранения ключей на сервере

#### 2. Обмен ключами (X25519 ECDH)

**Цель:** Генерация общего ключа шифрования между двумя пользователями

```dart
// Псевдокод
Пользователь A: приватныйКлючA + публичныйКлючB → общийСекретAB
Пользователь B: приватныйКлючB + публичныйКлючA → общийСекретAB

// Оба получают одинаковый общий секрет
общийСекретAB → SHA-256 → AES-256 ключ
```

**Свойства:**
- Perfect Forward Secrecy: Каждая сессия использует уникальный общий секрет
- Эллиптическая кривая: 256-битная безопасность (эквивалент 3072-бит RSA)
- Сервер не может вычислить общий секрет (zero-knowledge)

#### 3. Шифрование сообщений (AES-256-GCM)

**Цель:** Шифрование содержимого сообщения

**Алгоритм:** AES-256 в режиме GCM
- **Размер ключа:** 256 бит
- **Nonce:** 96 бит (случайный)
- **MAC:** 128 бит (тег аутентификации)

**Свойства:**
- Аутентифицированное шифрование: Целостность + конфиденциальность
- Устойчиво к подделке
- Nonce никогда не повторяется (случайная генерация)

**Процесс шифрования:**
```
открытыйТекст + общийКлюч + случайныйNonce → [шифротекст + MAC]
```

**Процесс расшифровки:**
```
[шифротекст + MAC] + общийКлюч → проверка MAC → открытыйТекст
```

---

## Модель угроз

### От чего мы защищаем

#### ✅ Защищено:

1. **Пассивный мониторинг сети**
   - Провайдер не может читать сообщения
   - Государственная слежка не может расшифровать
   - DPI не может извлечь содержимое

2. **Компрометация сервера**
   - Администратор сервера не может читать сообщения
   - Взлом сервера не раскрывает содержимое сообщений
   - Логи сервера содержат только зашифрованные данные

3. **Атака человек посередине (MITM)**
   - Обмен публичными ключами проверяется через код доступа
   - Каждый пользователь проверяет публичный ID собеседника
   - Сервер не может выдавать себя за пользователей

4. **Подделка сообщений**
   - AES-GCM MAC обнаруживает модификации
   - Невалидный MAC → сообщение отклонено

5. **Атаки повторного воспроизведения**
   - Проверка временных меток (сообщения старше 24ч удаляются)
   - Уникальность Nonce предотвращает повтор

#### ❌ НЕ защищено:

1. **Компрометация конечного устройства**
   - Если устройство взломано, сообщения читаемы
   - Кейлоггер может перехватывать сообщения до шифрования
   - **Защита:** Безопасность устройства (PIN, шифрование и т.д.)

2. **Утечка кода доступа**
   - Если код украден, атакующий получает ту же идентичность
   - **Защита:** Держите код в секрете, функция аварийной очистки

3. **Анализ трафика**
   - Сервер знает кто с кем общается
   - Сервер знает время/размер сообщений
   - **Защита:** Используйте Tor/VPN для приватности метаданных

4. **Запись экрана / Скриншоты**
   - Визуальный доступ к устройству раскрывает сообщения
   - **Защита:** Физическая безопасность устройства

---

## Функции безопасности

### 1. Zero-Knowledge сервер

**Что сервер ЗНАЕТ:**
- Пользователь онлайн/офлайн
- Маршрутизация сообщений (от → кому)
- Размер и временную метку сообщения

**Что сервер НЕ МОЖЕТ знать:**
- Содержимое сообщения (зашифровано)
- Идентичность пользователя (видит только хеш публичного ключа)
- Связь между кодом доступа и публичным ID

### 2. Локальное зашифрованное хранилище

**Формат хранения:**
```
flutter_secure_storage (платформенный keychain)
├── contacts (зашифрованный JSON)
├── messages_<contactID> (зашифрованный JSON на контакт)
├── public_key (base64)
├── private_key (base64)
└── access_code (сохранён для удобства)
```

**Безопасность платформы:**
- **Android:** Android Keystore (аппаратная поддержка на современных устройствах)
- **Windows:** Windows Credential Manager (DPAPI)

### 3. Безопасность офлайн сообщений

**Хранилище сервера:**
```
pendingMessages[userID] = [
  {зашифрованное_сообщение_1},
  {зашифрованное_сообщение_2},
  ...
]
```

**Свойства:**
- Сообщения хранятся зашифрованными (сервер не может читать)
- TTL 24 часа (автоматическая очистка)
- Доставляются при следующем подключении
- Удаляются с сервера после доставки

### 4. Безопасность мультиустройства

**Один код доступа = Одна идентичность:**
```
Устройство A: код → пара_ключей A
Устройство B: код → пара_ключей A (идентичны!)
```

**Преимущества:**
- Бесшовный вход с нескольких устройств
- Не нужно связывание устройств

**Риски:**
- Компрометация кода = все устройства скомпрометированы
- **Защита:** Держите код в максимальной безопасности

---

## Устойчивость к атакам

### 1. Человек посередине (MITM)

**Сценарий атаки:**
```
Пользователь A ──► Атакующий ──► Сервер ──► Пользователь B
```

**Защита:**
- Публичные ключи выведены из кода доступа (проверяемы)
- Пользователи могут проверить публичный ID собеседника вне канала
- Сервер не может модифицировать публичные ключи (детерминированы из кода)

**Рекомендация:** 
- Проверяйте публичный ID собеседника лично или через доверенный канал
- Сравните первые 8 символов публичного ID

### 2. Компрометация сервера

**Сценарий атаки:**
- Атакующий получает root доступ к VPS
- Читает всю память сервера и логи

**Что получает атакующий:**
- Список онлайн пользователей (публичные ID)
- Очередь зашифрованных сообщений
- Метаданные маршрутизации сообщений

**Что атакующий НЕ МОЖЕТ получить:**
- Открытый текст сообщений (зашифровано E2EE)
- Коды доступа (не хранятся на сервере)
- Приватные ключи (хранятся только у клиентов)

### 3. Атака повторного воспроизведения

**Сценарий атаки:**
- Атакующий перехватывает зашифрованное сообщение
- Отправляет его позже получателю повторно

**Защита:**
- Случайность Nonce (разный шифротекст каждый раз)
- Проверка временных меток (24-часовое окно)
- Дедупликация на уровне приложения

### 4. Отказ в обслуживании (DoS)

**Сценарий атаки:**
- Атакующий флудит сервер подключениями

**Защита:**
- Валидация кода доступа (атакующим нужны валидные коды)
- Ограничение скорости на сетевом уровне (файрвол)
- Малая база пользователей (10-50) делает DoS менее привлекательным

**Рекомендация:**
- Используйте fail2ban или аналог
- Ограничьте подключения с одного IP

### 5. Анализ трафика

**Сценарий атаки:**
- Противник мониторит сетевой трафик
- Узнаёт кто с кем общается, когда, сколько

**Текущий статус:** НЕ ЗАЩИЩЕНО
- Сервер видит метаданные маршрутизации
- Провайдер видит трафик к/от IP сервера

**Варианты защиты:**
1. Используйте VPN/Tor для клиентских подключений
2. Добавьте фиктивный трафик (cover traffic)
3. Реализуйте onion routing (будущая работа)

---

## Известные ограничения

### 1. Утечка метаданных

**Проблема:** Сервер знает паттерны коммуникации

**Влияние:** Среднее
- Кто с кем общается
- Частота сообщений
- Время онлайн/офлайн

**Защита:**
- Используйте Tor/VPN
- Добавление трафика-заполнителя (будущее)

### 2. Нет Perfect Forward Secrecy (PFS)

**Проблема:** Одна и та же пара ключей для всех сессий

**Влияние:** Среднее
- Если код доступа скомпрометирован, все прошлые сообщения расшифруемы (если перехвачены)

**Защита:**
- Периодически меняйте коды доступа
- Будущее: Реализация Signal Protocol (Double Ratchet)

### 3. Код доступа = Мастер-ключ

**Проблема:** Единая точка отказа

**Влияние:** Высокое при компрометации
- Утечка кода → полный доступ к аккаунту

**Защита:**
- Храните код максимально безопасно
- Функция аварийной очистки
- Только сильные случайные коды

### 4. Нет аутентификации сообщения (кроме MAC)

**Проблема:** Нет криптографической подписи подтверждающей отправителя

**Влияние:** Низкое (модель доверия предполагает честность сервера)
- Злонамеренный сервер теоретически мог бы выдавать себя за пользователей

**Будущее улучшение:**
- Подписывайте сообщения приватным ключом Ed25519

### 5. Agora звонки - Внешняя зависимость

**Проблема:** Голосовые/видео звонки полагаются на Agora SDK

**Статус безопасности:**
- Agora использует E2EE для звонков
- Но Agora - закрытый исходный код
- Требуется доверие к Agora

**Защита:**
- Звонки используют отдельный слой шифрования
- Будущее: WebRTC самостоятельно размещённый (без внешних)

---

## Лучшие практики

### Для пользователей:

1. **Безопасность кода доступа:**
   - ✅ Храните код в менеджере паролей
   - ✅ Никогда не делитесь кодом по незащищённым каналам
   - ❌ Не пишите код на бумаге/в заметках
   - ❌ Не делитесь кодом в соцсетях

2. **Безопасность устройства:**
   - ✅ Включите блокировку устройства (PIN/биометрия)
   - ✅ Держите ОС обновлённой
   - ✅ Используйте полное шифрование диска
   - ❌ Не делайте root/jailbreak устройства

3. **Сетевая безопасность:**
   - ✅ Используйте VPN в ненадёжных сетях
   - ✅ Избегайте публичный WiFi для конфиденциальных чатов
   - ❌ Не отключайте HTTPS/SSL проверку

4. **Аварийные процедуры:**
   - ✅ Используйте "Аварийную очистку" при потере устройства
   - ✅ Свяжитесь с админом для нового кода доступа
   - ❌ Не пытайтесь "восстановить" потерянный код (невозможно)

### Для администраторов:

1. **Генерация кодов доступа:**
   ```bash
   # Только сильные случайные коды!
   openssl rand -base64 20 | tr -d '/+=' | head -c 24 | \
     sed 's/\(....\)/SECURE-\1-/g' | sed 's/-$//'
   ```
   - ✅ Используйте криптографически безопасный рандом
   - ❌ Не используйте предсказуемые паттерны
   - ❌ Не переиспользуйте коды

2. **Укрепление сервера:**
   ```bash
   # Файрвол
   sudo ufw default deny incoming
   sudo ufw allow 22   # SSH
   sudo ufw allow 9090 # Мессенджер
   
   # Fail2ban
   sudo apt install fail2ban
   
   # Автообновления
   sudo apt install unattended-upgrades
   ```

3. **Управление кодами доступа:**
   - ✅ Храните коды в зашифрованной базе данных
   - ✅ Распространяйте через защищённый канал (лично, Signal и т.д.)
   - ❌ Никогда не коммитьте коды в Git
   - ❌ Никогда не отправляйте коды по незашифрованной почте

4. **Мониторинг:**
   ```bash
   # Регулярная проверка логов
   sudo journalctl -u messenger-server -f
   
   # Следите за подозрительной активностью
   grep "Invalid" /var/log/messenger.log
   ```

---

## Раскрытие уязвимостей

### Сообщение о проблемах безопасности

Если вы обнаружили уязвимость безопасности, пожалуйста:

1. **НЕ** открывайте публичный issue на GitHub
2. Email: [Ваша почта безопасности здесь]
3. Включите:
   - Описание уязвимости
   - Шаги воспроизведения
   - Потенциальное влияние
   - Предлагаемое исправление (если есть)

### Временные рамки ответа

- **24 часа:** Первоначальный ответ
- **7 дней:** Оценка и рейтинг серьёзности
- **30 дней:** Разработка и тестирование патча
- **Публичное раскрытие:** После выпуска патча (координированное раскрытие)

### Обновления безопасности

- Исправления безопасности выпускаются как патчи
- Критические проблемы: Немедленное уведомление всех пользователей
- Незначительные проблемы: Включены в регулярные обновления

---

## Статус аудита безопасности

### Текущий статус

- ✅ Проверка кода завершена (Декабрь 2024)
- ⏳ Независимый аудит безопасности: В ожидании
- ⏳ Тестирование на проникновение: В ожидании

### Известные проблемы

Критических уязвимостей в настоящее время не известно.

### Будущие улучшения

1. **Реализация Perfect Forward Secrecy**
   - Signal Protocol / Double Ratchet
   - Ротация ключей на сессию

2. **Добавление подписей сообщений**
   - Подписывайте сообщения с Ed25519
   - Предотвращение выдачи себя за другого сервером

3. **Самостоятельно размещённые звонки**
   - Замена Agora на WebRTC
   - Полный контроль над инфраструктурой звонков

4. **Защита метаданных**
   - Добавление трафика-заполнителя
   - Реализация смешивания (задержка сообщений)

---

## Соответствие

### Соответствие GDPR

- ✅ Нет сбора персональных данных (нет телефона/email)
- ✅ Пользователь контролирует все данные (локальное хранилище)
- ✅ Право на удаление (аварийная очистка)
- ✅ Минимизация данных (только зашифрованные данные на сервере)

### Хранение данных

- **Клиент:** Контролируется пользователем (удаление в любое время)
- **Сервер:** Максимум 24 часа (только офлайн сообщения)

---

## Заключение

Secure P2P Messenger обеспечивает сильное сквозное шифрование подходящее для:
- Приватная командная коммуникация
- Конфиденциальные деловые обсуждения
- Личная переписка с фокусом на приватность

**Сильные стороны:**
- ✅ Шифрование военного уровня (X25519 + AES-256-GCM)
- ✅ Zero-knowledge сервер
- ✅ Не требуется номер телефона / email
- ✅ Поддержка мультиустройств

**Ограничения:**
- ⚠️ Метаданные не скрыты
- ⚠️ Код доступа = единая точка отказа
- ⚠️ Нет PFS (пока)

**Рекомендация:** Подходит для групп требующих приватности, но не для жизненно опасных сценариев (активисты в авторитарных режимах). Для максимальной безопасности комбинируйте с VPN/Tor.

---

**Вопросы? [GitHub Discussions](https://github.com/sssilverhand/secure-p2p-messenger/discussions)**

**Сделано с ❤️ автором [sssilverhand](https://github.com/sssilverhand)**
